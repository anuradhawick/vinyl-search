<br />
<!--Search-->
<div class="p-2 flex justify-between flex-wrap">
  <div class="flex flex-wrap w-full">
    <mat-form-field class="grow max-w-md" style="height: 60px">
      <input
        matInput
        class="-translate-y-[10px]"
        (focus)="autocompleteShow = true"
        (blur)="exitSearch()"
        (keyup)="autocompleteEvent.next($any($event).target.value)"
        type="text"
        placeholder="Search records..."
        name="search-query"
        [(ngModel)]="query"
      />
    </mat-form-field>
    <div class="flex justify-start gap-1 md:justify-between grow">
      <button
        class="md:ml-2"
        mat-raised-button
        color="primary"
        (click)="search()"
      >
        Search
      </button>
      <button mat-raised-button color="primary" routerLink="/records/new">
        Add
      </button>
    </div>
    @if (autocompleteShow && autocompleteResult?.records?.length > 0) {
      <div
        class="z-10 p-2 max-w-md absolute top-[76px] left-2 right-2 bg-white border-solid border-slate-400 border-2 rounded-md overflow-hidden"
      >
        <table class="w-full">
          <tbody>
            @for (record of autocompleteResult?.records; track record) {
              <tr>
                <td>
                  <a [routerLink]="['/records', record.id, 'view']">
                    <strong>{{
                      _.truncate(record.name, { length: 60 })
                    }}</strong>
                    <br />
                    <div class="blockquote-footer">
                      {{ _.truncate(record.label, { length: 60 }) }}
                    </div>
                  </a>
                  @if (!$last) {
                    <hr />
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
  @if (
    loader.isHidden() &&
    !_.isEmpty(_.trim(_.get(route.queryParams | async, "query")))
  ) {
    <div class="ml-3 mr-5 mt-2 text-dark">
      Search results for - <em>{{ _.truncate(query, { length: 100 }) }}</em> (<a
        [routerLink]="['/records']"
        >cancel</a
      >)
    </div>
  }
</div>
<!--End Search-->
<div class="flex flex-col md:flex-row">
  <div class="w-full md:w-3/12 p-2">
    <mat-card>
      <mat-card-content>
        <h4 class="font-medium">Welcome to recrods database!</h4>
        <hr />
        <p class="font-normal">
          Enjoy the vast collection of genuine Vinyl records. Use the provided
          filters or use search function to find what you desire.
        </p>
      </mat-card-content>
    </mat-card>
    <br />
    <!--Filters-->
    <mat-accordion multi>
      <mat-expansion-panel hideToggle>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Filter by Genre
            {{ genreFilters.length > 0 ? "(" + genreFilters.length + ")" : "" }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <hr />
        <button
          mat-raised-button
          color="primary"
          class="w-full"
          (click)="openFilter(objectKeys(genresJSON), 'genreFilters')"
        >
          Select filters
        </button>
        @if (!_.isEmpty(genreFilters)) {
          <button
            mat-raised-button
            class="w-full"
            color="warn"
            (click)="genreFilters = []; activateFilters()"
          >
            Clear filters
          </button>
        }
      </mat-expansion-panel>
      <mat-expansion-panel hideToggle>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Filter by Style
            {{ styleFilters.length > 0 ? "(" + styleFilters.length + ")" : "" }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <hr />
        <button
          mat-raised-button
          color="primary"
          class="w-full"
          (click)="openFilter(getStyles(), 'styleFilters')"
        >
          Select filters
        </button>
        @if (!_.isEmpty(styleFilters)) {
          <button
            mat-raised-button
            class="w-full"
            color="warn"
            (click)="styleFilters = []; activateFilters()"
          >
            Clear filters
          </button>
        }
      </mat-expansion-panel>
      <mat-expansion-panel hideToggle>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Filter by Format
            {{
              formatFilters.length > 0 ? "(" + formatFilters.length + ")" : ""
            }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <hr />
        <button
          mat-raised-button
          color="primary"
          class="w-full"
          (click)="
            openFilter(
              [
                'Vinyl',
                'Acetate',
                'Flexi-Disc',
                'Lathe Cut',
                'Shellac',
                'CD',
                'DVD',
                'Mini Disc',
                'Cassette Tape',
                '4-Track Cartridge',
                '8-Track Cartridge',
                'Other/Unknown'
              ],
              'formatFilters'
            )
          "
        >
          Select filters
        </button>
        @if (!_.isEmpty(formatFilters)) {
          <button
            mat-raised-button
            class="w-full"
            color="warn"
            (click)="formatFilters = []; activateFilters()"
          >
            Clear filters
          </button>
        }
      </mat-expansion-panel>
      <mat-expansion-panel hideToggle>
        <mat-expansion-panel-header>
          <mat-panel-title>
            Filter by Country
            {{
              countryFilters.length > 0 ? "(" + countryFilters.length + ")" : ""
            }}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <hr />
        <button
          mat-raised-button
          color="primary"
          class="w-full"
          (click)="openFilter(getCountries(), 'countryFilters')"
        >
          Select filters
        </button>
        @if (!_.isEmpty(countryFilters)) {
          <button
            mat-raised-button
            class="w-full"
            color="warn"
            (click)="countryFilters = []; activateFilters()"
          >
            Clear filters
          </button>
        }
      </mat-expansion-panel>
    </mat-accordion>
  </div>
  <!--End filters-->
  <!--Records cards-->
  <div class="w-full md:w-9/12 p-2">
    <app-loader #recordsloader></app-loader>
    <div class="grid md:grid-cols-6 md:gap-4 grid-cols-3 gap-2">
      @for (r of $any(_.get(records | async, "records")); track r) {
        <div>
          <div class="bg-white rounded-md shadow-xl h-full">
            <div>
              <a
                [routerLink]="['/records', r.id, 'view']"
                class="h-full w-full"
              >
                <div class="w-full h-full">
                  <img
                    [src]="
                      r.images[r.chosenImage] ||
                      '/assets/images/records-new-sample.svg'
                    "
                    class="min-w-full object-cover object-center aspect-square rounded-t-lg"
                  />
                </div>
                <p
                  class="m-0 mx-1 mt-1 font-medium text-black text-sm truncate"
                >
                  {{ r.name }}
                </p>
                <p
                  class="m-0 mx-1 mb-1 font-medium text-gray-700 text-xs truncate"
                >
                  {{ r.label }}
                </p>
              </a>
            </div>
          </div>
        </div>
      }
    </div>
    <br />
    @if ((records | async) && count > limit) {
      <nav>
        <mat-paginator
          class="bg-slate-50"
          showFirstLastButtons
          [length]="count"
          [pageSize]="limit"
          [pageIndex]="page - 1"
          (page)="changePage($event)"
        ></mat-paginator>
      </nav>
    }
  </div>
  <!--End records cards-->
</div>
